<!DOCTYPE html>
<html lang="en">

<!-- layout.ejs-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="just keep lerning">
    <meta name="author" content="Hangfan Liu">
    <meta name="keyword" content="hexo, hexo theme, A-RSnippet, responsive, bootstrap">
    <link rel="canonical" href="http://yoursite.com/kafka-definitive-guide/">
    <link rel="shortcut icon" href="https://cdn4.iconfinder.com/data/icons/ionicons/512/icon-person-128.png">
    <link rel="alternate" type="application/atom+xml" title="Studio &lt;a class=&#34;github-button&#34; href=&#34;https://github.com/huyingjie/hexo-theme-A-RSnippet&#34; data-icon=&#34;octicon-star&#34; data-show-count=&#34;true&#34; aria-label=&#34;Star huyingjie/hexo-theme-A-RSnippet on GitHub&#34;&gt;Star&lt;/a&gt;" href="/atom.xml">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <title>
        
        kafka-definitive-guide｜An A-RSnippet Hexo Theme
        
    </title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    
<link rel="stylesheet" href="/css/main.css">


    
      <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
      
<link rel="stylesheet" href="/css/highlight.css">

    

    
      <script id="dsq-count-scr" src="//hexo-a-rsnippet.disqus.com/count.js" async></script>
    


    
      <meta name="google-site-verification" content="wtCjI-zcpr2FYwWS3sI4OWzMK9e7VomDrZyxpVUUIng" />
    

    

    


    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-38355881-1', 'auto');
    ga('send', 'pageview');
</script>





    <script async defer src="https://buttons.github.io/buttons.js"></script>

    <!-- user customization -->
    
<link rel="stylesheet" href="/css/arsnippet.css">

    
<script src="/js/arsnippet.css.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>

<style>
    header.intro-header {
        background-image: url('')
    }
</style>
<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="animated fadeIn">
<header>
  <nav class="navbar navbar-default header-navbar" id="nav-top" data-ispost = "true" data-istags="false" data-ishome = "false" >
    <div class="container-fluid">
      <div class="navbar-header page-scroll">
        <button type="button" class="navbar-toggle" data-toggle="collapse" aria-expanded="false"  data-target="#website_navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <span class="navbar-brand animated pulse">
          <a class="brand-logo" href="/">
            Studio <a class="github-button" target="_blank" rel="noopener" href="https://github.com/huyingjie/hexo-theme-A-RSnippet" data-icon="octicon-star" data-show-count="true" aria-label="Star huyingjie/hexo-theme-A-RSnippet on GitHub">Star</a>
          </a>
        </span>
      </div>

      <div class="collapse navbar-collapse" id="website_navbar">
          <ul class="nav navbar-nav navbar-right">
              
                <li>
                  <a href="/">home</a>
                </li>
              
                <li>
                  <a href="/books/">Books-Notes</a>
                </li>
              
                <li>
                  <a href="/leetcode-category/">LeetCode-category</a>
                </li>
              
                <li>
                  <a href="/leetcode-tag/">LeetCode-tag</a>
                </li>
              
                <li>
                  <a href="/archives/">archives</a>
                </li>
              
                <li>
                  <a href="/tags/">tags</a>
                </li>
              
                <li>
                  <a href="/portfolio-slim/">projects</a>
                </li>
              
                <li>
                  <a href="/support/">support</a>
                </li>
              
                <li>
                  <a href="/atom.xml">RSS</a>
                </li>
              
          </ul>
      </div>
  </nav>


  
    <style>
       .intro-header {
          background-image: url('copyright-free-images.jpg');
      }
    </style>

    <div class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                    <div class="site-heading">
                        <h1>kafka-definitive-guide</h1>
                        
                          <div class="post-subtitle">keep reading and loving</div>
                        
                        
                          <span class="meta">
                               <span class="meta-item">Author: Hangfan Liu</span>
                               <span class="meta-item">Date: Sep 30, 2021</span>
                               
                                 <span class="meta-item">Updated On: Oct 10, 2021</span>
                               
                          </span>
                          <div class="tags text-center">
                              Categories: 
                              <a class="tag" href="/categories/#books"
                                 title="books">books</a>
                              
                          </div>
                          <div class="tags text-center">
                              Tags: 
                              <a class="tag" href="/tags/#Kafka"
                                 title="Kafka">Kafka</a>
                              
                          </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
  
</header>


<!-- Main Content -->
<!-- post.ejs -->
<article>
    <div class="container">
      <div class="col-lg-8 col-lg-offset-1 col-sm-9">
          
            <div class="text-center"><div class="addthis_inline_share_toolbox">
  <script type = "text/javascript" src = "//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5272bc2a7b3c1ddc" async = "async" ></script>
</div>
</div><hr>
          
          <div class="subscribe"><a href="http://eepurl.com/dh6iCD" target="_blank">Get Updated for Each Release!</a></div><p>
          <p align="center">The goal of A-RSnippet theme is to be comprehensive.</p>

<div align="center">
<a href="https://github.com/huyingjie/hexo-theme-A-RSnippet/tree/master" target="_blank"><img src="https://travis-ci.org/huyingjie/hexo-theme-A-RSnippet.svg?branch=master" style="display:inline"></a> <a href="https://discord.gg/CB6CPzq" target="_blank"><img src="https://img.shields.io/discord/405912462031060992.svg" style="display:inline"></a> <a href="http://hexo.io" target="_blank"><img src="https://img.shields.io/badge/hexo-%3E%3D%203.0-blue.svg" style="display:inline"></a> <a href="https://github.com/huyingjie/hexo-theme-A-RSnippet" target="_blank"><img src="https://img.shields.io/badge/Release-v0.1.0-red.svg"></a> <a href="https://github.com/huyingjie/hexo-theme-A-RSnippet/blob/master/LICENSE" target="_blank"><img src="https://img.shields.io/badge/license-GPL3-pink.svg" style="display:inline"></a></div>

<h1 id="Chapter-1-Meet-kafka"><a href="#Chapter-1-Meet-kafka" class="headerlink" title="Chapter 1 : Meet kafka"></a>Chapter 1 : Meet kafka</h1><p>Almost every company is powered by data, the less effort we spend on moving data around, the more we can focus on the core business at hand. It’ a reason reason why we need Kafka.</p>
<h1 id="Chapter-5-Kafka-internals"><a href="#Chapter-5-Kafka-internals" class="headerlink" title="Chapter 5: Kafka internals"></a>Chapter 5: Kafka internals</h1><p>This chapter introduces how Kafka replication works, request interaction between consumer &amp; producer, storage methods in file format &amp; indexes.</p>
<h2 id="Cluster-Membership"><a href="#Cluster-Membership" class="headerlink" title="Cluster Membership"></a>Cluster Membership</h2><ul>
<li>Kafka use Zookeeper to maintain the list of brokers.</li>
<li>Every broker registers itself with it’s unique ID in Zookeeper by creating ephemeral node. Therefore, Kafka components like consumer or producer can watch subscribed broker’s path in Zookeeper to get notify.</li>
<li>If a broker get crash, the ephemeral node that the broker crated will be automatically removed. Due to the replication, it can later safety recover.</li>
</ul>
<h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><ul>
<li>The Controller is one of the Kafka brokers, usually is the first broker starts in the cluster. Others broker create Zookeeper watch on this controller node to get notification. New Controller will be created when the old one get crash. All partitions that had a leader on that crashed one need a new leader.</li>
<li>In summarize, the controller is responsible for electing leaders among the partitions and replicas whenever it notice nodes join or leave the cluster. The controller use epoch number to prevent “split brain” scenario.</li>
</ul>
<h2 id="Replication"><a href="#Replication" class="headerlink" title="Replication"></a>Replication</h2><ul>
<li>As we said before, replication is a critical method to guarantee the availability and durability of Kafka.</li>
<li> Data in Kafka is organized by topics. Each topic is partitioned, and each partition can have multiple replicas. Those replicas are stored on brokers, and each broker typically stores hundreds or even thousands of replicas belonging to different topics and partitions.</li>
<li>Two types of replica:<ul>
<li><strong>Leader</strong>: All produce and consume requests go through the leader replica.</li>
<li><strong>Follower</strong> replicate messages from the leader and stay up to date. New Leader will be elected form follower if old leader get crash.</li>
</ul>
</li>
<li><strong>syn</strong>: in order to maintain the message order, replica send the leader fetch request. The fetch request contains offsets to prevent out of syn. Therefore, the leader knows each replica’s offsets.</li>
<li>Only in-sync replicas are eligible to be elected as partition leaders in case the existing leader fails.</li>
</ul>
<h2 id="Request-Processing"><a href="#Request-Processing" class="headerlink" title="Request Processing"></a>Request Processing</h2><ul>
<li>Most of what a Kafka broker does is process requests sent to the partition leaders from clients, partition replicas, and the controller</li>
<li>All requests have a standard header that include:<ul>
<li>Request types</li>
<li>Request version</li>
<li>Correlation ID (for errors log)</li>
<li>Client ID</li>
</ul>
</li>
<li>Two common types of requests are:<ul>
<li>Produce requests: Sent by producers and contain messages the clients write to kafka</li>
<li>Fetch requests: Sent by consumers and follower replicas when they read messages from Kafka brokers.</li>
</ul>
</li>
<li>All produce and fetch requests must be sent to the leader replica. The broker received requests should contains the leader for the relevant partition for the request. Therefore, another request called a <strong>metadata request</strong> can be used, which contains partition list in the interested topics, the replica for each partition, and leader replica’s ID.</li>
<li>Metadata is cached in every brokers. Client will also maintain this metadata by <strong>metadata request</strong>, and refresh it after “Not a Leader” error occurs.</li>
</ul>
<h3 id="Produce-request"><a href="#Produce-request" class="headerlink" title="Produce request"></a>Produce request</h3><p>running as following steps, if the broker that contains the lead replica for a partition receives a produce request.</p>
<ol>
<li>Does the user sending the data have write privileges on the topic?</li>
<li>number of acks specified in the request valid 0? 1? all?</li>
<li>If acks is set to all, are there enough in-sync replicas for safely writing the message?</li>
<li>Writing the new message to local disk</li>
</ol>
<h3 id="Fetch-request"><a href="#Fetch-request" class="headerlink" title="Fetch request"></a>Fetch request</h3><ol>
<li>partition leader checks if the request is valid (offset exists)</li>
<li>broker read messages from partition, send to the clients by zero-copy method.</li>
<li>Note that only the messages are cached in all in-sync replicas will be sent. Consumers only see messages that were replicated to in-sync replicas.</li>
</ol>
<h2 id="Physical-Storage"><a href="#Physical-Storage" class="headerlink" title="Physical Storage"></a>Physical Storage</h2><h3 id="Partition-Allocation"><a href="#Partition-Allocation" class="headerlink" title="Partition Allocation"></a>Partition Allocation</h3><ul>
<li>Kafka first keeps these rules to execute partition allocation within brokers:<ol>
<li>Spreading replicas evenly among brokers</li>
<li>For each partition, each replicas is on a different broker</li>
<li>assigning the replicas for each partition to different racks if possible (in Kafka release 0.10.0 and higher)</li>
</ol>
</li>
<li>Kafka use round-robin manner to determine the location for the leaders.</li>
</ul>
<h3 id="File-Management"><a href="#File-Management" class="headerlink" title="File Management"></a>File Management</h3><ul>
<li>Kafka use retention period for each topic to implement the retention concept.</li>
<li>Due to the huge time-consuming of message finding and purging in a large file, Kafka split each partition into several segments. A segment has limit time and size of data.</li>
<li>Each segment is stored in a single data file</li>
</ul>
<h3 id="File-format"><a href="#File-format" class="headerlink" title="File format"></a>File format</h3><ul>
<li>It’s recommended to use compression on the producer which will benefit for sending huge messages.</li>
<li>sending larger batches means better compression both over the network and on the broker disks.</li>
</ul>

          
            <a href="https://www.patreon.com/arsnippet" target="_blank"><img src="/img/patreon.png" alt="support my work at patron"></a> <a href="https://arsnippet.freeflarum.com/" target="_blank"><img src="/img/forum.jpg" alt="support my work at patron"></a> <a href="https://discord.gg/CB6CPzq" target="_blank"><img src="/img/discord.png" alt="Join the Discord"></a>
          
          <hr>
          <ul class="pager">
              
              <li class="previous">
                  <a href="/tutorial/" data-toggle="tooltip" data-placement="left"
                     title="it's better to burn out than to fade away">&larr; Previous Post</a>
              </li>
              
              
              <li class="next">
                  <a href="/elements/" data-toggle="tooltip" data-placement="top"
                     title="Elements">Next Post&rarr;</a>
              </li>
              
          </ul>
        
  <br>
  
  <!-- disqus start -->
  <div class="comment">
    <div id="disqus_thread"  class="disqus-thread"></div>
      <script>
      var disqus_shortname = 'hexo-a-rsnippet';
      
      var disqus_url = 'http://yoursite.com/kafka-definitive-guide/';
      
      (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      </script>
      <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  <!-- disqus end -->
  

  
  </div>


        
  <div class="hidden-xs col-sm-3 toc-col">
    <div class="toc-wrap">
        Table of Contents
        
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-1-Meet-kafka"><span class="toc-number">1.</span> <span class="toc-text">Chapter 1 : Meet kafka</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-5-Kafka-internals"><span class="toc-number">2.</span> <span class="toc-text">Chapter 5: Kafka internals</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Cluster-Membership"><span class="toc-number">2.1.</span> <span class="toc-text">Cluster Membership</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Controller"><span class="toc-number">2.2.</span> <span class="toc-text">Controller</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Replication"><span class="toc-number">2.3.</span> <span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Request-Processing"><span class="toc-number">2.4.</span> <span class="toc-text">Request Processing</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Produce-request"><span class="toc-number">2.4.1.</span> <span class="toc-text">Produce request</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fetch-request"><span class="toc-number">2.4.2.</span> <span class="toc-text">Fetch request</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Physical-Storage"><span class="toc-number">2.5.</span> <span class="toc-text">Physical Storage</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Partition-Allocation"><span class="toc-number">2.5.1.</span> <span class="toc-text">Partition Allocation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File-Management"><span class="toc-number">2.5.2.</span> <span class="toc-text">File Management</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File-format"><span class="toc-number">2.5.3.</span> <span class="toc-text">File format</span></a></li></ol></li></ol></li></ol>
        
    </div>
  </div>


      </div>
  </div>
</article>

<!-- Footer -->
<!-- footer.ejs -->
<footer>
    <div class="text-center">
      <ul class="list-inline">
          
              <li>
                  <a href="/atom.xml" target="_blank">
                      <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                      </span>
                  </a>
              </li>
          
          
              <li>
                  <a target="_blank" href="https://twitter.com/hangfan">
                      <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                      </span>
                  </a>
              </li>
          
          

          

          

          
              <li>
                  <a target="_blank"  href="https://github.com/hangfan.liu">
                      <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                      </span>
                  </a>
              </li>
          

          

          

      </ul>
     <div class="text-muted copyright">
            &copy;
            
              2021
            
            
              <i class="fa fa-heart"></i>
            
            Hangfan Liu
        <br>
          
              Powered by <a target="_blank" href="https://hexo.io">Hexo</a>
          
          
            |
          
          
              Theme - <a href="https://github.com/huyingjie/hexo-theme-A-RSnippet" target="_blank">A-RSnippet</a> v0.1.0
          
          
      </div>
    </div>
</footer>

<!-- Custom Theme JavaScript -->

<script src="/js/main.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>



</body>

</html>
